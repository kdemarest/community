<html>
<head>
<meta charset="utf-8"/>

<link rel="stylesheet" type="text/css" href="minireset.css">
<link rel="stylesheet" type="text/css" href="index.css">

<script src="jquery.3.3.1.js" charset="utf-8"></script>
<script src="utilModule.js" charset="utf-8"></script>
<script src="utilDebug.js" charset="utf-8"></script>

<script src="utilities.js" charset="utf-8"></script>
<script src="utilPick.js" charset="utf-8"></script>
<script src="utilMarkup.js" charset="utf-8"></script>
<script src="time.js" charset="utf-8"></script>
<script src="clock.js" charset="utf-8"></script>

<script src="dataNames.js" charset="utf-8"></script>
<script src="dataCulture.js" charset="utf-8"></script>
<script src="dataAspect.js" charset="utf-8"></script>

<script src="cLayout.js" charset="utf-8"></script>
<script src="cBuilder.js" charset="utf-8"></script>

<script src="person.js" charset="utf-8"></script>
<script src="habit.js" charset="utf-8"></script>
<script src="venue.js" charset="utf-8"></script>
<script src="household.js" charset="utf-8"></script>
<script src="aspect.js" charset="utf-8"></script>
<script src="community.js" charset="utf-8"></script>

<script src="views.js" charset="utf-8"></script>
<script src="gui.js" charset="utf-8"></script>

<script src="visual.js" charset="utf-8"></script>
<script src="panelMorale.js" charset="utf-8"></script>
<script src="panelWellbeing.js" charset="utf-8"></script>
<script src="panelProductivity.js" charset="utf-8"></script>
<script src="panelCity.js" charset="utf-8"></script>
<script src="viewPanel.js" charset="utf-8"></script>
<script src="viewSituation.js" charset="utf-8"></script>
<script src="viewPerson.js" charset="utf-8"></script>
<script src="viewHousehold.js" charset="utf-8"></script>

<script src="dataFeed.js" charset="utf-8"></script>

<script>

Module.realize();

window.Debug = DebugSetup({
	inception: false,
	production: true,
	household: false,
});


console.assert = function(n) {
	if( !n ) {
		debugger;
	}
}

Aspect.Situation = class {
	constructor(data) {
		Object.assign( this, data );
		this.isFirstDay = true;
	}
	destroy() {
		this.dead = true;
		if( this.onDestroy ) {
			this.onDestroy.call(this,this);
		}
	}
	tickDay() {
		if( this.isFirstDay ) {
			if( this.onFirstDay ) {
				this.onFirstDay.call(this,this);
			}
			this.isFirstDay = false
			if( this.dead ) return;
		}
		if( this.onDaily ) {
			this.onDaily.call(this,this);
		}
	}
}



function main() {
	let population = 20;

	let clock = new Time.Clock(1.0);


	let community = new Community( new CultureBase(Name.humanFirst,Name.humanLast) );
	community.clock = clock;

	community.communityBuilder.build(population);

	console.logInception( community.venueList.map( obj => obj.text ).join('\n') );
	console.log( community.personList.map( obj => obj.text ).join('\n') );
	console.logInception( community.householdList.map( obj => obj.text ).join('\n') );
	console.logInception( community.personList.map( person => person.textLineage ).join('\n') );
	console.logInception( "Population="+community.population+" and "+community.ancestorList.length+" dead" );

	community.dataFeed = {};
	community.dataFeed.wellbeing 	= new DataFeed.Wellbeing(community);
	community.dataFeed.morale		= new DataFeed.Morale(community);
	community.dataFeed.productivity	= new DataFeed.Productivity(community,community.dataFeed.morale,community.dataFeed.wellbeing);
	community.dataFeed.city			= new DataFeed.City(community);

	Gui.panelTier = {
		viewProductivity: 0,
		viewMorale: 1,
		viewWellbeing: 1,
		viewHousehold: 1,
		viewPerson: 1
	}

	function viewMakerFn() {
		this.add('productivity',new View.Productivity(	'viewProductivity', community.dataFeed.productivity ) );
		this.add('morale',		new View.Morale(		'viewMorale', community.dataFeed.morale ) );
		this.add('wellbeing',	new View.Wellbeing(		'viewWellbeing', community.dataFeed.wellbeing ) );
		this.add('city', 		new View.City(			'viewCity', community.dataFeed.city ) );
		this.add('situation',	new View.Situation(		'viewSituation' ) );
		this.add('household',	new View.Household(		'viewHousehold' ) );
		this.add('person',		new View.Person(		'viewPerson' ) );
	}

	let observer = {
		community: community
	};

	let gui = Gui.createManager( ()=>{} );
	gui.create( viewMakerFn );
	guiMessage( 'observer', observer );

	window.addEventListener('resize', onResize );
	onResize();

	setTimeout( ()=>{
		let event = new Event('resize');
		window.dispatchEvent(event);
	}, 100 );

	let famineHappened;
	function hackTick(dt) {
		if( !famineHappened ) {
			famineHappened = true;
			community.situationList.add( new Aspect.Situation({
				community: community,
				description: 'Famine!',
				onFirstDay: (sitch) => {
					sitch.community.aspect.food.silos.amount = 0;
					guiMessage( 'situation', 'Famine! All stored food wiped out!' );
					sitch.destroy();
				}
			}));
			community.situationList.add( new Aspect.Situation({
				community: community,
				description: 'Cistern Sabotage!',
				onFirstDay: (sitch) => {
					sitch.community.aspect.water.cisterns.amount = 0;
					guiMessage( 'situation', 'Cistern Sabotage! The cisterns were drained!' );
					sitch.destroy();
				}
			}));
		}
	}


	Time.animationFrameTicker( dt => {
		hackTick(dt);
		clock.tick(dt);
		community.tick(dt);
		gui.tick(dt);
		gui.render(dt);
	});
}

function onResize() {
	Gui.layout({
//		'#guiCity': {
//			height: self => $('window').height()
//		}
	});
}


</script>



</head>
<body>
	<div id="guiMain">
		<div class='col0'>
			<div id="guiCity">
				<div id="viewCity">
				</div>
			</div>
		</div>
		<div class='col1'>
			<div id="guiCommunity">
				<div id="viewProductivity">
				</div>
				<div id="guiSubPanels">
					<div id="viewMorale" class="midview">
					</div>
					<div id="viewWellbeing" class="midview">
					</div>
					<div id="viewHousehold" class="midview">
					</div>
					<div id="viewPerson" class="midview">
					</div>
				</div>
				<div id="viewSituation">
				</div>
			</div>
		</div>
	</div>
	<script>
	document.addEventListener("DOMContentLoaded", () => {
		main();
	})
	</script>

</body>
</html>
