<html>
<head>
<meta charset="utf-8"/>

<link rel="stylesheet" type="text/css" href="minireset.css">
<link rel="stylesheet" type="text/css" href="index.css">

<script src="jquery.3.3.1.js" charset="utf-8"></script>
<script src="utilModule.js" charset="utf-8"></script>

<script src="utilities.js" charset="utf-8"></script>
<script src="utilPick.js" charset="utf-8"></script>
<script src="time.js" charset="utf-8"></script>

<script src="dataNames.js" charset="utf-8"></script>
<script src="dataCulture.js" charset="utf-8"></script>
<script src="dataAspect.js" charset="utf-8"></script>

<script src="cBuilder.js" charset="utf-8"></script>

<script src="person.js" charset="utf-8"></script>
<script src="venue.js" charset="utf-8"></script>
<script src="household.js" charset="utf-8"></script>
<script src="aspect.js" charset="utf-8"></script>
<script src="community.js" charset="utf-8"></script>

<script src="views.js" charset="utf-8"></script>
<script src="gui.js" charset="utf-8"></script>

<script src="visual.js" charset="utf-8"></script>
<script src="panelMorale.js" charset="utf-8"></script>
<script src="panelWellbeing.js" charset="utf-8"></script>
<script src="panelProductivity.js" charset="utf-8"></script>

<script src="dataFeed.js" charset="utf-8"></script>

<script>

Module.realize();


console.assert = function(n) {
	if( !n ) {
		debugger;
	}
}

/*
let q = [];
for( let i=0 ; i<10000 ; ++i ) {
	let age = Math.pickAge(80);
//	console.log(age);
	q[age] = (q[age]||0)+0.05;
}
for( let i=0 ; i<80 ; ++i ) {
	console.log( i,':',String.padLeft('',q[i],'*') );
}
*/


Aspect.Event = class {
	constructor(data) {
		Object.assign( this, data );
		this.isFirstDay = true;
	}
	destroy() {
		this.dead = true;
		if( this.onDestroy ) {
			this.onDestroy.call(this);
		}
	}
	tickDay() {
		if( this.isFirstDay ) {
			if( this.actionFirst ) {
				this.actionFirst.call(this);
			}
			this.isFirstDay = false
			if( this.dead ) return;
		}
		if( this.onTick ) {
			this.onTick.call(this);
		}
	}
}



class ViewPanel extends ViewObserver {
	constructor(divId,makeComponentFn) {
		super();
		this.divId = divId;
		this.panel = new Visual.Canvas( divId, makeComponentFn );
		this.lastDay = -1;
	}
	get community() {
		return this.observer.community;
	}
	message(msg,payload) {
		super.message(msg,payload);
		if( msg == 'panelShow' ) {
			if( this.divId == payload ) {
				this.panel.visible = true;
			}
			else {
				let myTier = Gui.panelTier[this.divId];
				let tier   = Gui.panelTier[payload];
				if( tier == myTier ) {
					this.panel.visible = false;
				}
			}
			this.dirty = true;
		}
	}
	tick(dt) {
		if( this.community.day !== this.lastDay ) {
			this.panel.data.update();
			this.dirty = true;
			this.lastDay = this.community.day;
		}
this.dirty = true;

		this.panel.tick(dt);
	}
	render() {
		this.panel.render();
	}
}

function onResize() {
	Gui.layout({
		'#guiMain': {
			height: self => $('body').height() - self.offset().top - parseInt(self.css('margin-bottom'))
		},
		'#panelProductivity': {
			height: self => Math.max( 100, $('#guiMain').height()*0.50 ),
			width:  self => $(self).height()*1.5
		},
		'#panelWellbeing': {
			height: self => Math.max( 100, $('#guiMain').height()*0.40 ),
			width:  self => $(self).height()*1.5
		},
		'#panelMorale': {
			height: self => Math.max( 100, $('#guiMain').height()*0.40 ),
			width:  self => $(self).height()*1.5
		}
	});
}


function main() {
	let population = 20;

	let community = new Community( new CultureBase(Name.gnomeFirst,Name.gnomeLast) );

	community.communityBuilder.build(population);

	community.venueList.dump();
	community.personList.dump();
	community.householdList.dump();
	console.log( community.personList.map( person => person.textLineage ).join('\n') );
	console.log( "Population="+community.population+" and "+community.ancestorList.length+" dead" );

	community.dataFeed = {};
	community.dataFeed.wellbeing 	= new DataFeed.Wellbeing(community);
	community.dataFeed.morale		= new DataFeed.Morale(community);
	community.dataFeed.productivity	= new DataFeed.Productivity(community,community.dataFeed.morale,community.dataFeed.wellbeing);

	Gui.panelTier = {
		panelProductivity: 0,
		panelMorale: 1,
		panelWellbeing: 1
	}

	let viewProductivity = new ViewPanel( 'panelProductivity', root => {
		root.addData(		community.dataFeed.productivity );
		root.addLayout(		new PanelProductivity.Layout(root) );
		root.addVisuals(	new PanelProductivity.Visuals(root) );
		root.addElements(	new PanelProductivity.Elements(root) );
	});

	let viewMorale = new ViewPanel( 'panelMorale', root => {
		root.addData(		community.dataFeed.morale );
		root.addLayout(		new PanelMorale.Layout(root) );
		root.addVisuals(	new PanelMorale.Visuals(root) );
		root.addElements(	new PanelMorale.Elements(root) );
		root.visible = false;
	});

	let viewWellbeing = new ViewPanel( 'panelWellbeing', root => {
		root.addData(		community.dataFeed.wellbeing );
		root.addLayout(		new PanelWellbeing.Layout(root) );
		root.addVisuals(	new PanelWellbeing.Visuals(root) );
		root.addElements(	new PanelWellbeing.Elements(root) );
		root.visible = false;
	});


	let observer = {
		community: community
	};

	let gui = Gui.createManager( ()=>{} );
	gui.create( function() {
		this.add('productivity', viewProductivity );
		this.add('morale', viewMorale );
		this.add('wellbeing', viewWellbeing );
	});
	guiMessage( 'observer', observer );

	window.addEventListener('resize', onResize );
	onResize();

	setTimeout( ()=>{
		let event = new Event('resize');
		window.dispatchEvent(event);
	}, 100 );


	Time.animationFrameTicker( dt => {
		gui.tick(dt);
		gui.render(dt);
	});
}

</script>



</head>
<body>
	<div id="guiMain">
		<div class='col0'>
			<div id="guiCommunity">
				<div id="panelProductivity">
				</div>
				<div id="panelMorale" style="position:absolute;">
				</div>
				<div id="panelWellbeing" style="position:absolute;">
				</div>
			</div>
		</div>
	</div>
	<script>
	document.addEventListener("DOMContentLoaded", () => {
		main();
	})
	</script>

</body>
</html>
